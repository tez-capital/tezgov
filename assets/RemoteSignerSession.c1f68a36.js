var S=Object.defineProperty;var K=(o,t,e)=>t in o?S(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var g=(o,t,e)=>(K(o,typeof t!="symbol"?t+"":t,e),e);import{_ as z,E as O,x as T,y as A,z as I,O as y,Q as R}from"./main.fcc73858.js";import{S as U}from"./SessionBase.0da79371.js";import{H as N,a as w,S as l}from"./taquito-http-utils.es6.491b203a.js";import{p as c,e as $,V as B,I as D,a as V,h as F,m as P,f as k,t as b,i as H,g as q,c as m,j as L,b as _}from"./taquito-utils.es6.9e1a8ea2.js";import{b as j}from"./index.558d09ea.js";import"./DAppClient.ffc3f8ec.js";function d(o,t,e,s){function r(i){return i instanceof e?i:new e(function(n){n(i)})}return new(e||(e=Promise))(function(i,n){function a(u){try{p(s.next(u))}catch(f){n(f)}}function h(u){try{p(s.throw(u))}catch(f){n(f)}}function p(u){u.done?i(u.value):r(u.value).then(a,h)}p((s=s.apply(o,t||[])).next())})}class E extends Error{constructor(t,e){super(t),this.message=t,this.innerException=e,this.name="KeyNotFoundError"}}class M extends Error{constructor(t,e){super(t),this.message=t,this.innerException=e,this.name="OperationNotAuthorized"}}class C extends Error{constructor(t,e,s){super(t),this.message=t,this.innerException=e,this.data=s,this.name="BadSigningData"}}class Q extends Error{constructor(t,e){super(`Requested public key hash does not match the initialized public key hash: {
        requested: ${t},
        initialized: ${e}
      }`),this.requested=t,this.name="PublicKeyMismatch"}}class W extends Error{constructor(t,e){super(`
        Signature failed verification against public key: 
        {
          bytes: ${t},
          signature: ${e}
        }
      `),this.bytes=t,this.signature=e,this.name="SignatureVerificationFailedError"}}const v={ed:{pk:c.edpk,sk:c.edsk,pkh:c.tz1,sig:c.edsig},p2:{pk:c.p2pk,sk:c.p2sk,pkh:c.tz3,sig:c.p2sig},sp:{pk:c.sppk,sk:c.spsk,pkh:c.tz2,sig:c.spsig}};class G{constructor(t,e,s={},r=new N){if(this.pkh=t,this.rootUrl=e,this.options=s,this.http=r,$(this.pkh)!==B.VALID)throw new D(this.pkh)}publicKeyHash(){return d(this,void 0,void 0,function*(){return this.pkh})}createURL(t){return`${this.rootUrl.replace(/\/+$/g,"")}${t}`}publicKey(){return d(this,void 0,void 0,function*(){try{const{public_key:t}=yield this.http.createRequest({url:this.createURL(`/keys/${this.pkh}`),method:"GET",headers:this.options.headers});return t}catch(t){throw t instanceof w&&t.status===l.NOT_FOUND?new E(`Key not found: ${this.pkh}`,t):t}})}secretKey(){return d(this,void 0,void 0,function*(){throw new V("Secret key cannot be exposed")})}sign(t,e){return d(this,void 0,void 0,function*(){try{let s=F(t);typeof e<"u"&&(s=P(e,s));const r=k(b(s)),{signature:i}=yield this.http.createRequest({url:this.createURL(`/keys/${this.pkh}`),method:"POST",headers:this.options.headers},r),n=i.startsWith("sig")?i.substring(0,3):i.substring(0,5);if(!H(n))throw new q(i,"Unsupported signature given by remote signer");const a=m(i,c[n]),h=yield this.publicKey();if(yield this.verifyPublicKey(h),!L(r,h,i))throw new W(r,i);return{bytes:t,sig:_(a,c.sig),prefixSig:i,sbytes:t+k(b(a))}}catch(s){if(s instanceof w){if(s.status===l.NOT_FOUND)throw new E(`Key not found: ${this.pkh}`,s);if(s.status===l.FORBIDDEN)throw new M("Signing Operation not authorized",s);if(s.status===l.BAD_REQUEST)throw new C("Invalid data",s,{bytes:t,watermark:e})}throw s}})}verifyPublicKey(t){return d(this,void 0,void 0,function*(){const e=t.substring(0,2),s=m(t,v[e].pk),r=_(j.hash(s,20),v[e].pkh);if(r!==this.pkh)throw new Q(r,this.pkh)})}}const J=async(o,t,e)=>{const{create_toolkit:s}=await z(()=>import("./taquito.4a51c829.js"),["assets/taquito.4a51c829.js","assets/taquito.es6.dfb0aade.js","assets/taquito-http-utils.es6.491b203a.js","assets/main.fcc73858.js","assets/index.dec37447.css","assets/taquito-utils.es6.9e1a8ea2.js","assets/index.558d09ea.js"]),{tezos:r,forger:i}=await s(e.rpc),n=new G(o,t);r.setSignerProvider(n);const a=o,h=a?await r.rpc.getManagerKey(a):void 0;return{account:a,tezos:r,forger:i,managerKey:h==null?void 0:h.toString()}},{request_ledger_setup:X}=R();class x extends U{constructor(e,s,r,i,n){super(e,r,i,n);g(this,"url");this.url=s}get AccountType(){return O.Remote}get Icon(){return new T("cloud",A.icon)}get IsAccountSwitchSupported(){return!1}static async create(e,s,r,i){var u;const n=I[r];if(!n)throw new Error("Invalid network specification!");const{tezos:a,forger:h,managerKey:p}=await J(e,s,{...i,rpc:(u=i==null?void 0:i.rpc)!=null?u:n.rpc});return new x(e,s,a,h,{networkId:r,managerKey:p})}static async create_from_cache(){}logout(){}async switch_wallet(){const e=await X({networkId:this.NetworkId,rpc:this.Tezos.rpc.getRpcUrl()});if(!e)throw new Error("Aborted.");return e}async vote(e){const s=await this.forge_ballot_op(e),r=async()=>{const i=this.Tezos.wallet.context,n=await this.Tezos.signer.sign(s,new Uint8Array([3])),a=await this.Tezos.rpc.injectOperation(n.sbytes);return i.operationFactory.createOperation(a)};return new y(r,"Vote",{account:this.Account,ballot:e})}async propose(e){const s=await this.forge_proposals_op(e),r=async()=>{const i=this.Tezos.wallet.context,n=await this.Tezos.signer.sign(s,new Uint8Array([3])),a=await this.Tezos.rpc.injectOperation(n.sbytes);return i.operationFactory.createOperation(a)};return new y(r,"Propose",{account:this.Account,proposals:e})}}export{x as RemoteSession};
