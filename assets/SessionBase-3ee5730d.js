import{E as f,O as h,D as _,a as d,b as m}from"./taquito.es6-14c09632.js";import{r as b,O as g,M as l,m as T,q as S}from"./main-549ade1f.js";import{T as w}from"./DAppClient-9dad9c1c.js";import{B as u}from"./taquito-utils.es6-2790dd94.js";const z="edsigtkpiSSschcaCt9pUVrpNPf7TTcgvgDEDD6NCEHMy8NNQJCGnMfLZzYoQj74yLjo9wx6MPVV29CvVzgi7qEcEUok3k7AuMg";class L{constructor(t,e,o,a){this.options=a,this.isBaker=b(void 0),this.tezos=e,this.account=t,this.forger=o,this.refresh_is_baker()}get IsActive(){return this.options.managerKey!==void 0}get IsGuest(){return!1}get IsAccountSwitchSupported(){return!0}get Account(){return this.account}get NetworkId(){return this.options.networkId}get Tezos(){return this.tezos}get Forger(){return this.forger}get IsBaker(){return this.isBaker.value}async activate(){const t=async()=>await this.Tezos.wallet.transfer({to:this.Account,amount:1,mutez:!0}).send();return new g(t,"Activate Account",{account:this.Account})}async get_balance(){return(await this.tezos.rpc.getBalance(this.account)).toNumber()/l}async refresh_is_baker(){try{this.isBaker.value=await this.Tezos.rpc.getDelegate(this.Account)===this.Account}catch{this.isBaker.value=!1}}generate_operation_link(t){switch(this.NetworkId){case"ghostnet":return`https://ghostnet.tzkt.io/${t}`;default:return`https://tzkt.io/${t}`}}async get_total_voting_power({block:t}={block:"head"}){return(await T.get(`${this.Tezos.rpc.getRpcUrl()}/chains/${await this.Tezos.rpc.getChainId()}/blocks/${t}/votes/total_voting_power`)).data}async get_current_period_info(){const t={block:"head~2"},e={period:this.Tezos.rpc.getCurrentPeriod(t),currentQuorum:this.Tezos.rpc.getCurrentQuorum(t),totalVotes:this.get_total_voting_power(t),currentProposal:this.Tezos.rpc.getCurrentProposal(t),ballots:this.Tezos.rpc.getBallots(t),ballotList:this.Tezos.rpc.getBallotList(t),proposals:this.Tezos.rpc.getProposals(t)};await Promise.allSettled(Object.values(e));const o=await e.period,a=await e.currentQuorum/100,s=await e.totalVotes,i=await e.currentProposal,r=await e.ballots,c=await e.ballotList,p=await e.proposals,n={id:o.voting_period.index,kind:o.voting_period.kind,totalVotes:s,startPosition:o.voting_period.start_position,position:o.position,remaining:o.remaining};switch(o.voting_period.kind){case"proposal":return{...n,proposals:p,requiredVotes:s*.05};case"exploration":return{...n,currentProposal:i??"",requiredVotes:s*(a/100),ballots:r,ballotList:c};case"promotion":return{...n,currentProposal:i??"",requiredVotes:s*(a/100),ballots:r,ballotList:c};case"cooldown":case"adoption":return{...n,requiredVotes:0};case"testing_vote":case"testing":case"promotion_vote":throw new Error("not supported!")}}async get_current_period(){return await this.Tezos.rpc.getCurrentPeriod({block:"head~2"})}async get_current_proposals(){return await this.Tezos.rpc.getProposals({block:"head~2"})}async get_current_proposal(){return await this.Tezos.rpc.getCurrentProposal({block:"head~2"})}async get_branch(){return await this.Tezos.rpc.getBlockHash({block:"head~2"})}async forge_proposals(t){const e=await this.get_current_period();return{kind:w.PROPOSALS,source:this.Account,period:e.voting_period.index.toString(),proposals:t}}async forge_proposals_op(t){const e={branch:await this.get_branch(),contents:[await this.forge_proposals(t)]},o=this.Forger.forge(e);return console.log(e),o}async forge_ballot(t){const e=await this.get_current_period();return{kind:w.BALLOT,source:this.Account,period:e.voting_period.index.toString(),proposal:await this.get_current_proposal(),ballot:S[t]}}async forge_ballot_op(t){return this.Forger.forge({branch:await this.get_branch(),contents:[await this.forge_ballot(t)]})}async donate(t){let e=this.Tezos.wallet.transfer({to:"tz1UGkfyrT9yBt6U5PV7Qeui3pt3a8jffoWv",amount:t.multipliedBy(l).toNumber(),mutez:!0});const o=async()=>e.send();return new g(o,"Delegate",{account:this.Account,Donate:`${t.toString()} TEZ`})}async delegate(t){const e=async()=>await this.Tezos.wallet.setDelegate({delegate:t}).send();return new g(e,"Delegate",{account:this.Account,delegate:t})}async estimateOperation(t,e){const o={operation:{...t,signature:z},chain_id:await this.tezos.rpc.getChainId()};if(t.contents.length===0)throw new Error("No contents to estimate op limits");const{cost_per_byte:a}=await this.tezos.rpc.getConstants();console.log(o);const s=await this.tezos.rpc.runOperation(o);console.log("response",s);const i=s.contents[0],r="metadata"in i&&"operation_result"in i.metadata&&i.metadata.operation_result;if(!r||r.status==="failed"||r.status==="backtracked")throw console.log(r),new Error("Failed to estimate op limits");const c=e.length/2;let p="storage_size"in r&&"global_address"in r?Number(r.storage_size):0;p+="paid_storage_diff"in r?Number(r.paid_storage_diff):0;const n=Number(r.consumed_milligas??0);return console.log(r),f.createEstimateInstanceFromProperties([{storageLimit:p,milligasLimit:n,opSize:c,minimalFeePerStorageByteMutez:a.toNumber()}])}async forge_set_deposit_op(t){const e={kind:h.SET_DEPOSITS_LIMIT,source:this.Account,limit:new u(t).multipliedBy(l).toString(),counter:new u((await this.tezos.rpc.getContract(this.Account)).counter??0).plus(1).toString(),fee:_.DELEGATION.toString(),gas_limit:d.DELEGATION.toString(),storage_limit:m.DELEGATION.toString()},o={branch:await this.get_branch(),contents:[e]},a=await this.forger.forge(o),s=await this.estimateOperation(o,a);return Object.assign(e,{gas_limit:s.gasLimit.toString(),storage_limit:s.storageLimit.toString(),fee:s.suggestedFeeMutez.toString()}),await this.forger.forge(o)}async forge_update_consensus_key_op(t){const e={kind:h.UPDATE_CONSENSUS_KEY,source:this.Account,pk:t,counter:new u((await this.tezos.rpc.getContract(this.Account)).counter??0).plus(1).toString(),fee:_.DELEGATION.toString(),gas_limit:d.DELEGATION.toString(),storage_limit:m.DELEGATION.toString()},o={branch:await this.get_branch(),contents:[e]},a=await this.Forger.forge(o),s=await this.estimateOperation(o,a);return e.gas_limit=s.gasLimit.toString(),e.storage_limit=s.storageLimit.toString(),e.fee=s.suggestedFeeMutez.toString(),await this.Forger.forge(o)}}export{L as S};
