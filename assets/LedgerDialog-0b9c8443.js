import{I as A,i as G,V as H,p,P as v,a as M,b as m,c as O,d as F,T,e as Q,u as z,r as b,w as W,f as Z,s as j,o as I,g as Y,h,j as S,C as $,k as C,S as X,l as q,m as J,n as K,t as ee,F as B,q as L,L as te,v as se,_ as ie,x as re,y as ne,z as oe,A as ae}from"./main-02e039e1.js";function P(t,e,s,i){function r(n){return n instanceof s?n:new s(function(a){a(n)})}return new(s||(s=Promise))(function(n,a){function c(l){try{u(i.next(l))}catch(_){a(_)}}function g(l){try{u(i.throw(l))}catch(_){a(_)}}function u(l){l.done?n(l.value):r(l.value).then(c,g)}u((i=i.apply(t,e||[])).next())})}const k=230;function N(t){const e=[];t.split("/").forEach(r=>{let n=parseInt(r,10);Number.isNaN(n)||(r.length>1&&r[r.length-1]==="'"&&(n+=2147483648),e.push(n))});const i=Buffer.alloc(1+e.length*4);return i[0]=e.length,e.forEach((r,n)=>{i.writeUInt32BE(r,1+4*n)}),i}function le(t,e){return e===0||e===3?t=t.slice(1):(t[0]=2+(t[64]&1),t=t.slice(0,33)),t}function ce(t,e){let s=t;return typeof e<"u"&&(s=Buffer.from(e).toString("hex").concat(t)),s}function ue(t,e){let s=0;for(;s!==e.length;){const i=s+k>=e.length?e.length-s:k,r=Buffer.alloc(i);e.copy(r,0,s,s+i),t.push(r),s+=i}return t}function de(t){let e=!0;t[0]!==49&&t[0]!==48&&(e=!1),t[1]+4!==t.length&&(e=!1),t[2]!==2&&(e=!1);const s=t[3];t[4+s]!==2&&(e=!1);const i=5+s,r=t[i];return i+1+r+2!==t.length&&(e=!1),e}function V(t,e){const s=Buffer.alloc(32);s.fill(0);let i=e[t],r=t+1;return i>32&&(r+=i-32,i=32),e.copy(s,32-i,r,r+i),{buffer:s,idxValueStart:r,length:i}}class he extends T{constructor(e){super(),this.message=e,this.name="InvalidLedgerResponseError"}}class fe extends T{constructor(e){super(),this.cause=e,this.name="PublicKeyRetrievalError",this.message="Unable to retrieve Public Key from Ledger"}}class pe extends T{constructor(){super(),this.name="PublicKeyHashRetrievalError",this.message="Unable to retrieve Public Key Hash from Ledger"}}class ve extends M{constructor(e){super(),this.derivationType=e,this.name="InvalidDerivationTypeError",this.message=`Invalid derivation type ${e} expecting one of the following: DerivationType.ED25519, DerivationType.SECP256K1, DerivationType.P256 or DerivationType.BIP32_ED25519`}}var o;(function(t){t[t.ED25519=0]="ED25519",t[t.SECP256K1=1]="SECP256K1",t[t.P256=2]="P256",t[t.BIP32_ED25519=3]="BIP32_ED25519"})(o||(o={}));class we{constructor(e,s="44'/1729'/0'/0'",i=!0,r=o.ED25519){if(this.transport=e,this.path=s,this.prompt=i,this.derivationType=r,this.CLA=128,this.INS_GET_PUBLIC_KEY=2,this.INS_PROMPT_PUBLIC_KEY=3,this.INS_SIGN=4,this.FIRST_MESSAGE_SEQUENCE=0,this.LAST_MESSAGE_SEQUENCE=129,this.OTHER_MESSAGE_SEQUENCE=1,this.transport.setScrambleKey("XTZ"),!s.startsWith("44'/1729'"))throw new A(s,`${G(H.NO_PREFIX_MATCHED)} expecting prefix "44'/1729'".`);if(!Object.values(o).includes(r))throw new ve(r.toString())}publicKeyHash(){return P(this,void 0,void 0,function*(){if(this._publicKeyHash||(yield this.publicKey()),this._publicKeyHash)return this._publicKeyHash;throw new pe})}publicKey(){return P(this,void 0,void 0,function*(){if(this._publicKey)return this._publicKey;const e=yield this.getLedgerPublicKey(),s=e[0],i=e.slice(1,1+s),r=le(i,this.derivationType),n=this.getPrefixes(),a=m(r,n.prefPk),c=m(O.hash(r,20),n.prefPkh);return this._publicKey=a,this._publicKeyHash=c,a})}getLedgerPublicKey(){return P(this,void 0,void 0,function*(){try{let e=this.INS_PROMPT_PUBLIC_KEY;return this.prompt===!1&&(e=this.INS_GET_PUBLIC_KEY),yield this.transport.send(this.CLA,e,this.FIRST_MESSAGE_SEQUENCE,this.derivationType,N(this.path))}catch(e){throw new fe(e)}})}secretKey(){return P(this,void 0,void 0,function*(){throw new F("Secret key cannot be exposed")})}sign(e,s){return P(this,void 0,void 0,function*(){const i=ce(e,s),r=Buffer.from(i,"hex");let n=[];n.push(N(this.path)),n=ue(n,r);const a=yield this.signWithLedger(n);let c;if(this.derivationType===o.ED25519||this.derivationType===o.BIP32_ED25519)c=a.slice(0,a.length-2).toString("hex");else{if(!de(a))throw new he("Invalid signature return by ledger unable to parse the response");const u=V(3,a),l=u.idxValueStart+u.length+1,_=V(l,a);c=Buffer.concat([u.buffer,_.buffer]).toString("hex")}return{bytes:e,sig:m(c,p[v.SIG]),prefixSig:m(c,this.getPrefixes().prefSig),sbytes:e+c}})}signWithLedger(e){return P(this,void 0,void 0,function*(){let s=yield this.transport.send(this.CLA,this.INS_SIGN,this.FIRST_MESSAGE_SEQUENCE,this.derivationType,e[0]);for(let i=1;i<e.length;i++){const r=i===e.length-1?this.LAST_MESSAGE_SEQUENCE:this.OTHER_MESSAGE_SEQUENCE;s=yield this.transport.send(this.CLA,this.INS_SIGN,r,this.derivationType,e[i])}return s})}getPrefixes(){return this.derivationType===o.ED25519||this.derivationType===o.BIP32_ED25519?{prefPk:p[v.EDPK],prefPkh:p[v.TZ1],prefSig:p[v.EDSIG]}:this.derivationType===o.SECP256K1?{prefPk:p[v.SPPK],prefPkh:p[v.TZ2],prefSig:p[v.SPSIG]}:{prefPk:p[v.P2PK],prefPkh:p[v.TZ3],prefSig:p[v.P2SIG]}}}const x=t=>(re("data-v-b9bc9fad"),t=t(),ne(),t),_e={class:"center"},Ee={class:"card z-depth-2"},ge={class:"content"},Se=x(()=>h("div",{class:"icon-wrap center pv-2"},[h("img",{src:oe,width:"50"})],-1)),Pe=x(()=>h("div",{class:"headline pv-3"},"Connect your Ledger",-1)),ye={key:0,class:"deriv-path"},be=x(()=>h("div",{class:"pt-1 space-1"},null,-1)),me={key:1,class:"error-text pt-2"},xe=x(()=>h("div",{class:"pv-2 space-2",style:{"grid-row":"9","grid-colum":"1"}},null,-1)),Ie={class:"buttons pt-0 pb-2"},D="44'/1729'/0'/0'",Le=Q({__name:"LedgerDialog",props:{context:{}},emits:["cancel","confirm"],setup(t,{emit:e}){const s=t,i=z("Derivation Path"),r=[{id:o.ED25519,label:o[o.ED25519]},{id:o.SECP256K1,label:o[o.SECP256K1]},{id:o.P256,label:o[o.P256]},{id:o.BIP32_ED25519,label:o[o.BIP32_ED25519]}],n=b(!1),a=r[0],c=b(a),g=b(D),u=b(void 0),l=b(!1);let _=!1;W(()=>s.context.active,f=>{if(f)_=!1;else{l.value=!1,u.value=void 0;return}});const w=Z(()=>l.value||j(i.value,f=>f(n.value?g.value:D)!==!0));let E;const R=async()=>{try{l.value=!0;const{LedgerSession:f}=await ie(()=>import("./LedgerSession-96b7322a.js"),["assets/LedgerSession-96b7322a.js","assets/main-02e039e1.js","assets/index-3694a04e.css","assets/SessionBase-46796db9.js","assets/taquito.es6-c85b4f48.js","assets/DAppClient-5fff09c6.js"]);E=await f.create_transport();const d=await f.create(E,s.context.networkId,{rpc:s.context.rpc,derivationType:n.value?c.value.id:a.id,derivationPath:n.value?g.value:D});if(_&&d){d.logout();return}typeof s.context.confirm=="function"&&s.context.confirm(d),e("confirm",d)}catch(f){u.value=`Failed to login with ledger!
Error: ${f.message}`,E==null||E.close()}finally{l.value=!1}},U=()=>{_=!0,E==null||E.close(),typeof s.context.cancel=="function"&&s.context.cancel(),e("cancel")};return(f,d)=>(I(),Y(se,{to:"#dialog"},[h("div",{class:L(["modal",{"modal-active":f.context.active}]),key:"ledgerDialog"},[h("div",_e,[h("div",Ee,[h("div",ge,[Se,Pe,S($,{class:"custom-hd pb-2",label:"Use custom HD derivation path",modelValue:n.value,"onUpdate:modelValue":d[0]||(d[0]=y=>n.value=y)},null,8,["modelValue"]),n.value?(I(),C("div",ye,[S(X,{portaled:"",label:"Derivation Type",items:r,modelValue:c.value,"onUpdate:modelValue":d[1]||(d[1]=y=>c.value=y)},null,8,["modelValue"]),S(J,{modelValue:g.value,"onUpdate:modelValue":d[2]||(d[2]=y=>g.value=y),label:"Derivation Path",rules:q(i),"capitalize-label":!0},null,8,["modelValue","rules"])])):K("",!0),be,u.value?(I(),C("div",me,ee(u.value),1)):K("",!0),xe,h("div",Ie,[S(B,{onClick:U,label:"Cancel"}),S(B,{class:L(["confirm-btn",{disabled:w.value}]),onClick:R,label:"Connect"},null,8,["class"])])]),h("div",{class:L(["loader-wrap",{"loader-hidden":!l.value}])},[S(te,{class:"loader","is-indeterminate":!0,label:"Please confirm operation on your ledger..."})],2)])])],2)]))}});const De=ae(Le,[["__scopeId","data-v-b9bc9fad"]]),Ce=Object.freeze(Object.defineProperty({__proto__:null,default:De},Symbol.toStringTag,{value:"Module"}));export{we as L,Ce as a};
