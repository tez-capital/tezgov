import{p as f,P as p,b as x,a as R,c as U,d as A,u as G,r as m,w as H,e as M,s as O,o as I,f as Q,g as h,h as S,C as F,i as T,S as W,j as D,I as z,k as C,t as Z,F as K,n as L,L as j,T as Y,_ as $,l as X,m as q,q as J,v as ee}from"./main-31999e94.js";function P(t,e,i,s){function r(n){return n instanceof i?n:new i(function(a){a(n)})}return new(i||(i=Promise))(function(n,a){function l(u){try{c(s.next(u))}catch(g){a(g)}}function E(u){try{c(s.throw(u))}catch(g){a(g)}}function c(u){u.done?n(u.value):r(u.value).then(l,E)}c((s=s.apply(t,e||[])).next())})}const w=230;function B(t){const e=[];t.split("/").forEach(r=>{let n=parseInt(r,10);Number.isNaN(n)||(r.length>1&&r[r.length-1]==="'"&&(n+=2147483648),e.push(n))});const s=Buffer.alloc(1+e.length*4);return s[0]=e.length,e.forEach((r,n)=>{s.writeUInt32BE(r,1+4*n)}),s}function te(t,e){return e===0||e===3?t=t.slice(1):(t[0]=2+(t[64]&1),t=t.slice(0,33)),t}function ie(t,e){let i=t;return typeof e<"u"&&(i=Buffer.from(e).toString("hex").concat(t)),i}function se(t,e){let i=0;for(;i!==e.length;){const s=i+w>=e.length?e.length-i:w,r=Buffer.alloc(s);e.copy(r,0,i,i+s),t.push(r),i+=s}return t}function re(t){let e=!0;t[0]!==49&&t[0]!==48&&(e=!1),t[1]+4!==t.length&&(e=!1),t[2]!==2&&(e=!1);const i=t[3];t[4+i]!==2&&(e=!1);const s=5+i,r=t[s];return s+1+r+2!==t.length&&(e=!1),e}function k(t,e){const i=Buffer.alloc(32);i.fill(0);let s=e[t],r=t+1;return s>32&&(r+=s-32,s=32),e.copy(i,32-s,r,r+s),{buffer:i,idxValueStart:r,length:s}}class ne extends Error{constructor(e){super(e),this.message=e,this.name="InvalidLedgerResponseError"}}class oe extends Error{constructor(){super("Unable to retrieve Public Key from Ledger"),this.name="PublicKeyRetrievalError"}}class ae extends Error{constructor(){super("Unable to retrieve Public Key Hash from Ledger"),this.name="PublicKeyHashRetrievalError"}}var o;(function(t){t[t.ED25519=0]="ED25519",t[t.SECP256K1=1]="SECP256K1",t[t.P256=2]="P256",t[t.BIP32_ED25519=3]="BIP32_ED25519"})(o||(o={}));class le extends Error{constructor(e){super(`The derivation type ${e} is invalid. The derivation type must be DerivationType.ED25519, DerivationType.SECP256K1, DerivationType.P256 or DerivationType.BIP32_ED25519`),this.derivationType=e,this.name="InvalidDerivationTypeError"}}class ce extends Error{constructor(e){super(`The derivation path ${e} is invalid. The derivation path must start with 44'/1729`),this.derivationPath=e,this.name="InvalidDerivationPathError"}}class xe{constructor(e,i="44'/1729'/0'/0'",s=!0,r=o.ED25519){if(this.transport=e,this.path=i,this.prompt=s,this.derivationType=r,this.CLA=128,this.INS_GET_PUBLIC_KEY=2,this.INS_PROMPT_PUBLIC_KEY=3,this.INS_SIGN=4,this.FIRST_MESSAGE_SEQUENCE=0,this.LAST_MESSAGE_SEQUENCE=129,this.OTHER_MESSAGE_SEQUENCE=1,this.transport.setScrambleKey("XTZ"),!i.startsWith("44'/1729'"))throw new ce(i);if(!Object.values(o).includes(r))throw new le(r.toString())}publicKeyHash(){return P(this,void 0,void 0,function*(){if(this._publicKeyHash||(yield this.publicKey()),this._publicKeyHash)return this._publicKeyHash;throw new ae})}publicKey(){return P(this,void 0,void 0,function*(){if(this._publicKey)return this._publicKey;const e=yield this.getLedgerPublicKey(),i=e[0],s=e.slice(1,1+i),r=te(s,this.derivationType),n=this.getPrefixes(),a=x(r,n.prefPk),l=x(R.hash(r,20),n.prefPkh);return this._publicKey=a,this._publicKeyHash=l,a})}getLedgerPublicKey(){return P(this,void 0,void 0,function*(){try{let e=this.INS_PROMPT_PUBLIC_KEY;return this.prompt===!1&&(e=this.INS_GET_PUBLIC_KEY),yield this.transport.send(this.CLA,e,this.FIRST_MESSAGE_SEQUENCE,this.derivationType,B(this.path))}catch{throw new oe}})}secretKey(){return P(this,void 0,void 0,function*(){throw new U("Secret key cannot be exposed")})}sign(e,i){return P(this,void 0,void 0,function*(){const s=ie(e,i),r=Buffer.from(s,"hex");let n=[];n.push(B(this.path)),n=se(n,r);const a=yield this.signWithLedger(n);let l;if(this.derivationType===o.ED25519||this.derivationType===o.BIP32_ED25519)l=a.slice(0,a.length-2).toString("hex");else{if(!re(a))throw new ne("Cannot parse ledger response");const c=k(3,a),u=c.idxValueStart+c.length+1,g=k(u,a);l=Buffer.concat([c.buffer,g.buffer]).toString("hex")}return{bytes:e,sig:x(l,f[p.SIG]),prefixSig:x(l,this.getPrefixes().prefSig),sbytes:e+l}})}signWithLedger(e){return P(this,void 0,void 0,function*(){let i=yield this.transport.send(this.CLA,this.INS_SIGN,this.FIRST_MESSAGE_SEQUENCE,this.derivationType,e[0]);for(let s=1;s<e.length;s++){const r=s===e.length-1?this.LAST_MESSAGE_SEQUENCE:this.OTHER_MESSAGE_SEQUENCE;i=yield this.transport.send(this.CLA,this.INS_SIGN,r,this.derivationType,e[s])}return i})}getPrefixes(){return this.derivationType===o.ED25519||this.derivationType===o.BIP32_ED25519?{prefPk:f[p.EDPK],prefPkh:f[p.TZ1],prefSig:f[p.EDSIG]}:this.derivationType===o.SECP256K1?{prefPk:f[p.SPPK],prefPkh:f[p.TZ2],prefSig:f[p.SPSIG]}:{prefPk:f[p.P2PK],prefPkh:f[p.TZ3],prefSig:f[p.P2SIG]}}}const b=t=>(X("data-v-6c393358"),t=t(),q(),t),ue={class:"center"},de={class:"card z-depth-2"},he={class:"content"},fe=b(()=>h("div",{class:"icon-wrap center pv-2"},[h("img",{src:J,width:"50"})],-1)),pe=b(()=>h("div",{class:"headline pv-3"},"Connect your Ledger",-1)),ve={key:0,class:"deriv-path"},_e=b(()=>h("div",{class:"pt-1 space-1"},null,-1)),Ee={key:1,class:"error-text pt-2"},ge=b(()=>h("div",{class:"pv-2 space-2",style:{"grid-row":"9","grid-colum":"1"}},null,-1)),Se={class:"buttons pt-0 pb-2"},Pe=A({__name:"LedgerDialog",props:{context:null},emits:["cancel","confirm"],setup(t,{emit:e}){const i=t,s=G("Derivation Path"),r=[{id:o.ED25519,label:o[o.ED25519]},{id:o.SECP256K1,label:o[o.SECP256K1]},{id:o.P256,label:o[o.P256]},{id:o.BIP32_ED25519,label:o[o.BIP32_ED25519]}],n=m(!1),a=m(r[0]),l=m("44'/1729'/0'/0'"),E=m(void 0),c=m(!1);let u=!1;H(()=>i.context.active,_=>{if(_)u=!1;else{c.value=!1,E.value=void 0;return}});const g=M(()=>c.value||O(s.value,_=>_(l.value)!==!0));let v;const N=async()=>{try{c.value=!0;const{LedgerSession:_}=await $(()=>import("./LedgerSession-19908205.js"),["assets/LedgerSession-19908205.js","assets/main-31999e94.js","assets/index-bf468514.css","assets/SessionBase-8013a105.js","assets/taquito.es6-0764cd35.js","assets/DAppClient-0df61cf3.js"]);v=await _.create_transport();const d=await _.create(v,i.context.networkId,{rpc:i.context.rpc,derivationType:a.value.id,derivationPath:l.value});if(u&&d){d.logout();return}typeof i.context.confirm=="function"&&i.context.confirm(d),e("confirm",d)}catch(_){E.value=`Failed to login with ledger!
Error: ${_.message}`,v==null||v.close()}finally{c.value=!1}},V=()=>{u=!0,v==null||v.close(),typeof i.context.cancel=="function"&&i.context.cancel(),e("cancel")};return(_,d)=>(I(),Q(Y,{to:"#dialog"},[h("div",{class:L(["modal",{"modal-active":t.context.active}]),key:"ledgerDialog"},[h("div",ue,[h("div",de,[h("div",he,[fe,pe,S(F,{class:"custom-hd pb-2",label:"Use custom HD derivation path",modelValue:n.value,"onUpdate:modelValue":d[0]||(d[0]=y=>n.value=y)},null,8,["modelValue"]),n.value?(I(),T("div",ve,[S(W,{portaled:"",label:"Derivation Type",items:r,modelValue:a.value,"onUpdate:modelValue":d[1]||(d[1]=y=>a.value=y)},null,8,["modelValue"]),S(z,{modelValue:l.value,"onUpdate:modelValue":d[2]||(d[2]=y=>l.value=y),label:"Derivation Path",rules:D(s),"capitalize-label":!0},null,8,["modelValue","rules"])])):C("",!0),_e,E.value?(I(),T("div",Ee,Z(E.value),1)):C("",!0),ge,h("div",Se,[S(K,{onClick:V,label:"Cancel"}),S(K,{class:L(["confirm-btn",{disabled:D(g)}]),onClick:N,label:"Connect"},null,8,["class"])])]),h("div",{class:L(["loader-wrap",{"loader-hidden":!c.value}])},[S(j,{class:"loader","is-indeterminate":!0,label:"Please confirm operation on your ledger..."})],2)])])],2)]))}});const ye=ee(Pe,[["__scopeId","data-v-6c393358"]]),be=Object.freeze(Object.defineProperty({__proto__:null,default:ye},Symbol.toStringTag,{value:"Module"}));export{xe as L,be as a};
