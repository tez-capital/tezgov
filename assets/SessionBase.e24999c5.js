var w=Object.defineProperty;var _=(n,t,e)=>t in n?w(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var c=(n,t,e)=>(_(n,typeof t!="symbol"?t+"":t,e),e);import{y,z as m,A as f,B as b,O as a,M as u,r as A,D as k,G as T}from"./main.e52d1d5f.js";import{d as z}from"./taquito-utils.es6.9aabf825.js";import{T as g}from"./DAppClient.94b42220.js";class C extends y{constructor(e){super(m(),f.creating,b.onChain,"Deploy contract...");c(this,"operation");c(this,"op");this.operation=e}async send(){return this.op=await this.operation(),this.update_hash(this.op.opHash),{ophash:this.op.opHash}}async confirmation(){if(!this.op)throw new Error("Operation has to be send first!");const e=await this.op.confirmation(),s=await this.op.contract();return this.description=`Deployed: ${s.address}`,{block:{hash:e.block.hash,level:e.block.header.level}}}}class v{constructor(t){c(this,"session");this.session=t}get Base(){return this.session}get ContractAddress(){return this.session.AdminContract.ContractAddress}async withdraw(t){const e=async()=>await this.session.AdminContract.withdraw(t*u);return new a(e,`Withdraw ${t}TEZ from the contract.`,{amount:t})}async withdraw_to(t,e){const s=async()=>await this.session.AdminContract.withdraw_to(t*u,e);return new a(s,`Withdraw ${t}TEZ from the contract to ${e}.`,{amount:t,to:e})}async get_delegate(){return await this.session.AdminContract.get_delegate()}async delegate(t){const e=async()=>await this.session.AdminContract.delegate(t);return new a(e,`Delegate contract balance to ${t}.`,{baker:t})}async transfer_ownership(t){const e=async()=>await this.session.AdminContract.transfer_ownership(t);return new a(e,`Transfer contract ownership to ${t}.`,{to:t})}async take_ownership(){const t=async()=>await this.session.AdminContract.take_ownership();return new a(t,"Claim contract ownership.")}async get_contract_balance(){return(await this.session.Tezos.rpc.getBalance(this.session.AdminContract.ContractAddress)).toNumber()/u}async deploy_contract(t,e){const s=async()=>await this.session.Tezos.wallet.originate({code:t,init:e}).send();return new C(s)}async update_metadata(t){const e={},p=await(await this.session.Contract.get_contract_storage()).metadata.getMultipleValues(Object.keys(t));for(const r of Object.keys(t)){const h=z(t[r]);p.get(r)!=h&&(e[r]=h)}const i=async()=>await this.session.AdminContract.update_metadata([...Object.keys(e).map(r=>({key:r,value:e[r]}))]);return new a(i,"Update Metadata",{metadata:t})}async update_extension(t){const s=(await this.session.Tezos.contract.at(this.ContractAddress)).parameterSchema.Execute(JSON.parse(t)),o=async()=>await this.session.AdminContract.update_ext(s.update_ext);return new a(o,"Update Extension",{code:t})}async update_extension_storage(t,e,s){const o=async()=>await this.session.AdminContract.update_ext_storage([{key:{0:t,1:e},value:s}]);return new a(o,"Update Extension Storage",{kind:t,key:e,value:s})}}class P{constructor(t,e,s,o){c(this,"tezos");c(this,"account");c(this,"forger");c(this,"isBaker",A(void 0));this.options=o,this.tezos=e,this.account=t,this.forger=s,this.refresh_is_baker()}get IsActive(){return this.options.managerKey!==void 0}get IsGuest(){return!1}get IsAccountSwitchSupported(){return!0}get Account(){return this.account}get NetworkId(){return this.options.networkId}get Tezos(){return this.tezos}get Forger(){return this.forger}get IsBaker(){return this.isBaker.value}async activate(){const t=async()=>await this.Tezos.wallet.transfer({to:this.Account,amount:1,mutez:!0}).send();return new a(t,"Activate Account",{account:this.Account})}async get_balance(){return(await this.tezos.rpc.getBalance(this.account)).toNumber()/u}async refresh_is_baker(){try{this.isBaker.value=await this.Tezos.rpc.getDelegate(this.Account)===this.Account}catch{console.log(this.isBaker),this.isBaker.value=!1}}get_admin_session(){return new v(this)}generate_operation_link(t){switch(this.NetworkId){case"ghostnet":return`https://ghostnet.tzkt.io/${t}`;default:return`https://tzkt.io/${t}`}}async get_total_voting_power({block:t}={block:"head"}){return(await k.get(`${this.Tezos.rpc.getRpcUrl()}/chains/${await this.Tezos.rpc.getChainId()}/blocks/${t}/votes/total_voting_power`)).data}async get_current_period_info(){const t={block:"head~2"},e={period:this.Tezos.rpc.getCurrentPeriod(t),currentQuorum:this.Tezos.rpc.getCurrentQuorum(t),totalVotes:this.get_total_voting_power(t),currentProposal:this.Tezos.rpc.getCurrentProposal(t),ballots:this.Tezos.rpc.getBallots(t),ballotList:this.Tezos.rpc.getBallotList(t),proposals:this.Tezos.rpc.getProposals(t)};await Promise.allSettled(Object.values(e));const s=await e.period,o=await e.currentQuorum/100,p=await e.totalVotes,i=await e.currentProposal,r=await e.ballots,h=await e.ballotList,d=await e.proposals,l={id:s.voting_period.index,kind:s.voting_period.kind,totalVotes:p,startPosition:s.voting_period.start_position,position:s.position,remaining:s.remaining};switch(s.voting_period.kind){case"proposal":return{...l,proposals:d,requiredVotes:p*.05};case"exploration":return{...l,currentProposal:i!=null?i:"",requiredVotes:p*(o/100),ballots:r,ballotList:h};case"promotion":return{...l,currentProposal:i!=null?i:"",requiredVotes:p*(o/100),ballots:r,ballotList:h};case"cooldown":case"adoption":return{...l,requiredVotes:0};case"testing_vote":case"testing":case"promotion_vote":throw new Error("not supported!")}}async get_current_period(){return await this.Tezos.rpc.getCurrentPeriod({block:"head~2"})}async get_current_proposals(){return await this.Tezos.rpc.getProposals({block:"head~2"})}async get_branch(){return await this.Tezos.rpc.getBlockHash({block:"head~10"})}async forge_proposals(t){const e=await this.get_current_period();return{kind:g.PROPOSALS,source:this.Account,period:e.voting_period.index.toString(),proposals:t}}async forge_proposals_op(t){const e={branch:await this.get_branch(),contents:[await this.forge_proposals(t)]},s=this.Forger.forge(e);return console.log(e),s}async forge_ballot(t){const e=await this.get_current_period();return{kind:g.BALLOT,source:this.Account,period:e.voting_period.index.toString(),proposal:"PtLimaPtLMwfNinJi9rCfDPWea8dFgTZ1MeJ9f1m2SRic6ayiwW",ballot:T[t]}}async forge_ballot_op(t){return this.Forger.forge({branch:await this.get_branch(),contents:[await this.forge_ballot(t)]})}async donate(t){let e=this.Tezos.wallet.batch();for(const o of t)e=e.withTransfer(o);const s=async()=>e.send();return new a(s,"Delegate",{account:this.Account,donations:t})}async delegate(t){const e=async()=>await this.Tezos.wallet.setDelegate({delegate:t}).send();return new a(e,"Delegate",{account:this.Account,delegate:t})}}export{P as S};
